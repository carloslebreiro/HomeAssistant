version: '3.1'

services:
#HomeAssistant
  homeassistant:
    image:  homeassistant/home-assistant
    restart: always
    networks:
      - traefik_proxy
    volumes:
      - ha_config:/config
      - node_red:/data_nodered
    links:
      - mqtt
      - mqtt:mqtt
      - influxdb
      - influxdb:influxdb
    labels:
       - "traefik.backend=homeassistant"
       - "traefik.frontend.rule=Host:ptorrezao.duckdns.org"
       - "traefik.port=8123"
       - "traefik.docker.network=traefik_proxy"
       - "traefik.enable=true"
#DB
  db:
    image: mariadb
    restart: always
    deploy:
      placement:
        constraints:
          - node.role == manager
    environment:
      MYSQL_ROOT_PASSWORD: "${MYSQL_PWD}"
    networks:
      - traefik_proxy
    volumes:
      - ha_mysql:/var/lib/mysql
      
#MQTT
  mqtt:
    image: eclipse-mosquitto:latest
    networks:
      - traefik_proxy
    restart: always
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - mqtt_data:/mosquitto

#Node Red
  nodered:
    image: nodered/node-red-docker:v8
    networks:
      - traefik_proxy
    deploy:
      replicas: 1
    volumes:
      - node_red:/data
    labels:
       - "traefik.backend=NodeRed"
       - "traefik.frontend.rule=Host:nodered.ptorrezao.duckdns.org"
       - "traefik.port=1880"
       - "traefik.docker.network=traefik_proxy"
       - "traefik.enable=true"
#tasmoadmin      
  tasmoadmin:
    image: raymondmm/tasmoadmin
    restart: always
    deploy:
      replicas: 1
    networks:
      - traefik_proxy
    volumes:
      - tasmoadmin:/data
    labels:
       - "traefik.backend=tasmoadmin"
       - "traefik.frontend.rule=Host:TasmoAdmin.ptorrezao.duckdns.org"
       - "traefik.port=80"
       - "traefik.docker.network=traefik_proxy"
       - "traefik.enable=true"
      
#Samba Shares      
  samba:
    image: dperson/samba
    restart: always
    deploy:
      replicas: 1
    ports:
      - "137:137/udp"
      - "138:138/udp"
      - "139:139/tcp"
      - "445:445/tcp"
    volumes:
      - ha_config:/config
      - tasmoadmin:/tasmoadmin
      - mqtt_data:/mqtt_data
      - home_data:/home_data
    command: '-u "${SAMBA_USER};${SAMBA_PWD}" -s "backups;/home_data;yes;no;no;${SAMBA_USER}" -s "MQTT;/mqtt_data;yes;no;no;${SAMBA_USER}" -s "TasmoAdmin;/tasmoadmin;yes;no;no;${SAMBA_USER}" -s "HomeAssistant;/config;yes;no;no;${SAMBA_USER}" -p'
    
volumes:
  ha_config:
  node_red:
  tasmoadmin:
  mqtt_data:
  home_data:
  ha_mysql: 

networks:
  traefik_proxy:
    external:
      name: traefik_proxy